    [iapetos.core :as prometheus]
    [iapetos.collector.jvm :as jvm]
    [iapetos.collector.ring :as ring]





    (defonce registry
             (-> (prometheus/collector-registry)
                 jvm/initialize
                 ring/initialize
                 (prometheus/register )))


(defn wrap-metrics [app]
  (ring/wrap-metrics app
                     registry
                     {:path "/metrics" }))
; (def app
wrap-metrics

                                           ; make sure we are not creating a metric for every postcode
                                           ; this would still create metrics for not existing paths
                                           :path-fn #(re-find #"^/[^/]+" (:uri %))

docker-compose -f docker-compose.yml -f docker-compose.prom-data.yml up --build

                  (prometheus/summary :clojure-prometheus-demo/crimes-lookup-seconds)
                  (prometheus/summary :clojure-prometheus-demo/postcode-lookup-seconds)


                      (prometheus/with-duration
                        (registry :clojure-prometheus-demo/postcode-lookup-seconds)

                          (prometheus/with-duration
                            (registry :clojure-prometheus-demo/crimes-lookup-seconds)


rate(process_cpu_seconds_total{job="app"}[15s])

curl localhost:8080/crime/HA74PD
siege -c 1 -d 5s -t 5m http://localhost:8080/crime/HA74PD

increase(http_request_latency_seconds_sum{path="/crime"}[1m]) / increase(http_request_latency_seconds_count{path="/crime"}[1m])

increase(clojure_prometheus_demo_crimes_lookup_seconds_sum[1m]) / increase(clojure_prometheus_demo_crimes_lookup_seconds_count[1m])
increase(clojure_prometheus_demo_postcode_lookup_seconds_sum[1m]) / increase(clojure_prometheus_demo_postcode_lookup_seconds_count[1m])
increase(http_request_latency_seconds_count{path="/crime"}[1m])